<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KnowledgeVault - Workflow</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Header */
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; }
        header h1 { font-size: 2em; margin-bottom: 10px; }
        .stats { display: flex; gap: 20px; margin-top: 15px; }
        .stat { background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 8px; }
        .stat-value { font-size: 1.5em; font-weight: bold; }

        /* Workflow Steps */
        .workflow-steps { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; }
        .step { flex: 1; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; transition: all 0.3s; }
        .step.active { background: #667eea; color: white; border-color: #667eea; }
        .step.completed { background: #28a745; color: white; border-color: #28a745; }
        .step-number { font-size: 1.5em; font-weight: bold; }

        /* Content Panels */
        .panel { display: none; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .panel.active { display: block; }

        /* Message Review */
        .message-list { max-height: 500px; overflow-y: auto; }
        .message-item { display: flex; align-items: flex-start; padding: 15px; border-bottom: 1px solid #eee; gap: 15px; }
        .message-item:hover { background: #f8f9fa; }
        .message-content { flex: 1; }
        .message-meta { font-size: 0.8em; color: #666; margin-top: 5px; }
        .message-score { padding: 3px 8px; border-radius: 12px; font-size: 0.75em; }
        .score-high { background: #d4edda; color: #155724; }
        .score-medium { background: #fff3cd; color: #856404; }
        .score-low { background: #f8d7da; color: #721c24; }
        .message-actions { display: flex; gap: 5px; }
        .btn-include, .btn-exclude { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .btn-include { background: #28a745; color: white; }
        .btn-exclude { background: #dc3545; color: white; }

        /* Filter */
        .filter-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-bar select, .filter-bar input { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; }
        .filter-bar select { min-width: 200px; }

        /* Questions Panel */
        .question-card { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #667eea; }
        .question-text { font-size: 1.1em; margin-bottom: 15px; }
        .question-meta { font-size: 0.85em; color: #666; margin-bottom: 10px; }
        .answer-area { margin-top: 15px; }
        .answer-area textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; min-height: 100px; font-size: 1em; resize: vertical; }

        /* Voice Recording */
        .voice-controls { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
        .btn-record { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .btn-record.idle { background: #667eea; color: white; }
        .btn-record.recording { background: #dc3545; color: white; animation: pulse 1s infinite; }
        .btn-submit-answer { background: #28a745; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Search Panel */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-box input { flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; }
        .search-box button { padding: 15px 30px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .answer-box { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; white-space: pre-wrap; line-height: 1.6; }

        /* Progress */
        .progress-bar { height: 8px; background: #e0e0e0; border-radius: 4px; margin: 10px 0; }
        .progress-fill { height: 100%; background: #28a745; border-radius: 4px; transition: width 0.3s; }

        /* Batch Actions */
        .batch-actions { display: flex; gap: 10px; margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 10px; }
        .batch-actions button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }

        /* Pagination */
        .pagination { display: flex; gap: 5px; justify-content: center; margin-top: 20px; }
        .pagination button { padding: 8px 15px; border: 1px solid #e0e0e0; background: white; border-radius: 5px; cursor: pointer; }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }

        .loading { text-align: center; padding: 40px; color: #667eea; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>KnowledgeVault</h1>
            <p>Knowledge Base Builder for {{ stats.target_user }}</p>
            <div class="stats">
                <div class="stat"><div class="stat-value" id="doc-count">{{ stats.total_documents }}</div><div>Documents</div></div>
                <div class="stat"><div class="stat-value" id="gap-count">{{ stats.total_gaps }}</div><div>Questions</div></div>
                <div class="stat"><div class="stat-value" id="review-count">-</div><div>Need Review</div></div>
            </div>
        </header>

        <!-- Workflow Steps -->
        <div class="workflow-steps">
            <div class="step" data-step="0" onclick="showStep(0)">
                <div class="step-number">0</div>
                <div>Connect APIs</div>
            </div>
            <div class="step active" data-step="1" onclick="showStep(1)">
                <div class="step-number">1</div>
                <div>Filter Messages</div>
            </div>
            <div class="step" data-step="2" onclick="showStep(2)">
                <div class="step-number">2</div>
                <div>Answer Questions</div>
            </div>
            <div class="step" data-step="3" onclick="showStep(3)">
                <div class="step-number">3</div>
                <div>Search Knowledge</div>
            </div>
            <div class="step" data-step="4" onclick="showStep(4)">
                <div class="step-number">4</div>
                <div>Stakeholders</div>
            </div>
        </div>

        <!-- Step 0: Connect APIs -->
        <div class="panel" id="panel-0">
            <h2>Connect Data Sources</h2>
            <p style="color: #666; margin-bottom: 20px;">Connect your accounts to import knowledge from external sources.</p>

            <div id="connectors-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                <div class="loading">Loading connectors...</div>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3 style="margin-bottom: 10px;">Add Connector Credentials</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Connector Type</label>
                        <select id="connector-type" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; min-width: 150px;">
                            <option value="gmail">Gmail</option>
                            <option value="slack">Slack</option>
                            <option value="github">GitHub</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">API Token / Credentials</label>
                        <input type="password" id="connector-token" placeholder="Paste your API token here..." style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <button onclick="addConnector()" style="padding: 10px 25px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Connect
                    </button>
                </div>
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button onclick="showStep(1)" style="padding: 15px 30px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                    Continue to Filter Messages ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 1: Filter Messages -->
        <div class="panel active" id="panel-1">
            <h2>Review Uncertain Messages</h2>
            <p style="color: #666; margin-bottom: 20px;">These messages couldn't be automatically classified. Include work-related messages, exclude personal ones.</p>

            <div class="filter-bar">
                <select id="space-filter" onchange="loadMessages()">
                    <option value="">All Projects</option>
                </select>
                <span id="message-count-label">Loading...</span>
            </div>

            <div class="batch-actions">
                <button onclick="includeAllVisible()" style="background: #28a745; color: white;">Include All Visible</button>
                <button onclick="excludeAllVisible()" style="background: #dc3545; color: white;">Exclude All Visible</button>
                <span style="margin-left: auto; color: #666;" id="selected-count">0 selected</span>
            </div>

            <div class="message-list" id="message-list">
                <div class="loading">Loading messages...</div>
            </div>

            <div class="pagination" id="pagination"></div>

            <div style="margin-top: 20px; text-align: right;">
                <button onclick="saveDecisionsAndNext()" style="padding: 15px 30px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                    Save & Continue to Questions ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Answer Questions -->
        <div class="panel" id="panel-2">
            <h2>Answer Knowledge Questions</h2>
            <p style="color: #666; margin-bottom: 20px;">Answer these questions to fill gaps in the knowledge base. Use voice or text.</p>

            <div class="filter-bar">
                <select id="question-filter" onchange="loadQuestions()">
                    <option value="">All Types</option>
                    <option value="technical">Technical Questions</option>
                    <option value="project_goal">Project Goals</option>
                    <option value="success_criteria">Success Criteria</option>
                </select>
                <select id="project-filter" onchange="loadQuestions()">
                    <option value="">All Projects</option>
                </select>
            </div>

            <div id="questions-list">
                <div class="loading">Loading questions...</div>
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button onclick="showStep(3)" style="padding: 15px 30px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                    Continue to Search ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 3: Search -->
        <div class="panel" id="panel-3">
            <h2>Search Knowledge Base</h2>
            <p style="color: #666; margin-bottom: 20px;">Ask questions about your projects. The RAG now includes your answers.</p>

            <div class="search-box">
                <input type="text" id="search-input" placeholder="Ask a question about your projects..." onkeypress="if(event.key==='Enter')doSearch()">
                <button onclick="doSearch()">Search</button>
            </div>

            <div id="search-results"></div>
        </div>

        <!-- Step 4: Stakeholders -->
        <div class="panel" id="panel-4">
            <h2>Stakeholder Map</h2>
            <p style="color: #666; margin-bottom: 20px;">View people, their expertise, and projects. Ask "who knows" questions.</p>

            <div class="search-box" style="margin-bottom: 30px;">
                <input type="text" id="stakeholder-search" placeholder="Ask: Who knows about financial analysis? Who worked on NICU project?" onkeypress="if(event.key==='Enter')searchStakeholders()">
                <button onclick="searchStakeholders()">Ask</button>
            </div>

            <div id="stakeholder-answer" style="display: none; background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px;"></div>

            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                <div style="flex: 2; min-width: 400px;">
                    <h3 style="margin-bottom: 15px;">People in Knowledge Base</h3>
                    <div id="stakeholders-list" style="max-height: 500px; overflow-y: auto;">
                        <div class="loading">Loading stakeholders...</div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 250px;">
                    <h3 style="margin-bottom: 15px;">Expertise Domains</h3>
                    <div id="expertise-list">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentMessages = [];
        let decisions = {};
        let mediaRecorder = null;
        let audioChunks = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMessages();
            loadReviewCount();
            loadProjectFilters();
        });

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            document.getElementById(`panel-${step}`).classList.add('active');

            if (step === 2) loadQuestions();
        }

        // Message Review Functions
        async function loadMessages(page = 1) {
            currentPage = page;
            const spaceFilter = document.getElementById('space-filter').value;
            const url = `/api/messages/review?page=${page}&per_page=20${spaceFilter ? '&space=' + encodeURIComponent(spaceFilter) : ''}`;

            try {
                const resp = await fetch(url);
                const data = await resp.json();
                currentMessages = data.messages;
                totalPages = data.total_pages;

                document.getElementById('message-count-label').textContent = `${data.total} messages need review`;

                // Populate space filter
                const spaceSelect = document.getElementById('space-filter');
                if (spaceSelect.options.length === 1) {
                    data.spaces.forEach(space => {
                        const opt = document.createElement('option');
                        opt.value = space;
                        opt.textContent = space;
                        spaceSelect.appendChild(opt);
                    });
                }

                renderMessages();
                renderPagination();
            } catch (err) {
                document.getElementById('message-list').innerHTML = '<div class="loading">Error loading messages</div>';
            }
        }

        function renderMessages() {
            const list = document.getElementById('message-list');
            if (currentMessages.length === 0) {
                list.innerHTML = '<div style="padding: 40px; text-align: center; color: #28a745;">All messages reviewed! Continue to the next step.</div>';
                return;
            }

            list.innerHTML = currentMessages.map((msg, i) => {
                const scoreClass = msg.professional_score >= 60 ? 'score-high' : msg.professional_score >= 40 ? 'score-medium' : 'score-low';
                const decided = decisions[msg.content];
                return `
                    <div class="message-item" id="msg-${i}" style="${decided !== undefined ? 'opacity: 0.5;' : ''}">
                        <div class="message-content">
                            <div>${escapeHtml(msg.content)}</div>
                            <div class="message-meta">
                                <strong>${msg.space}</strong> | ${msg.sender || 'Unknown'} |
                                <span class="message-score ${scoreClass}">Score: ${msg.professional_score}</span>
                            </div>
                        </div>
                        <div class="message-actions">
                            <button class="btn-include" onclick="decideMessage(${i}, true)" ${decided === true ? 'disabled' : ''}>Include</button>
                            <button class="btn-exclude" onclick="decideMessage(${i}, false)" ${decided === false ? 'disabled' : ''}>Exclude</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function decideMessage(index, include) {
            const msg = currentMessages[index];
            decisions[msg.content] = include;
            document.getElementById(`msg-${index}`).style.opacity = '0.5';
            updateSelectedCount();
        }

        function includeAllVisible() {
            currentMessages.forEach((msg, i) => {
                decisions[msg.content] = true;
            });
            renderMessages();
            updateSelectedCount();
        }

        function excludeAllVisible() {
            currentMessages.forEach((msg, i) => {
                decisions[msg.content] = false;
            });
            renderMessages();
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = Object.keys(decisions).length;
            document.getElementById('selected-count').textContent = `${count} decided`;
        }

        async function saveDecisionsAndNext() {
            const decisionList = Object.entries(decisions).map(([content, include]) => ({content, include}));

            if (decisionList.length > 0) {
                try {
                    await fetch('/api/messages/review/decide', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({decisions: decisionList})
                    });
                    decisions = {};
                    loadReviewCount();
                } catch (err) {
                    alert('Error saving decisions');
                    return;
                }
            }
            showStep(2);
        }

        function renderPagination() {
            const container = document.getElementById('pagination');
            let html = '';
            for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="loadMessages(${i})">${i}</button>`;
            }
            if (totalPages > 10) html += `<span>... ${totalPages} pages</span>`;
            container.innerHTML = html;
        }

        async function loadReviewCount() {
            try {
                const resp = await fetch('/api/messages/review?per_page=1');
                const data = await resp.json();
                document.getElementById('review-count').textContent = data.total;
            } catch (err) {}
        }

        // Questions Functions
        async function loadQuestions() {
            const typeFilter = document.getElementById('question-filter').value;
            const projectFilter = document.getElementById('project-filter').value;

            try {
                const resp = await fetch('/api/gaps');
                const data = await resp.json();

                let questions = [];
                Object.values(data.by_severity || {}).forEach(arr => questions.push(...arr));

                // Filter
                if (typeFilter) {
                    questions = questions.filter(q => q.type === typeFilter || q.source === 'gpt_analysis' && typeFilter === 'technical');
                }
                if (projectFilter) {
                    questions = questions.filter(q => q.project === projectFilter);
                }

                // Populate project filter
                const projectSelect = document.getElementById('project-filter');
                if (projectSelect.options.length === 1) {
                    const projects = [...new Set(questions.map(q => q.project))];
                    projects.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p;
                        opt.textContent = p;
                        projectSelect.appendChild(opt);
                    });
                }

                renderQuestions(questions.slice(0, 20));
            } catch (err) {
                document.getElementById('questions-list').innerHTML = '<div class="loading">Error loading questions</div>';
            }
        }

        function renderQuestions(questions) {
            const container = document.getElementById('questions-list');

            if (questions.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center;">No questions found</div>';
                return;
            }

            container.innerHTML = questions.map((q, i) => `
                <div class="question-card" id="question-${i}">
                    <div class="question-meta">
                        <strong>${q.project}</strong> |
                        ${q.type === 'technical' || q.source === 'gpt_analysis' ? 'üîß Technical' :
                          q.type === 'project_goal' ? 'üéØ Goal' :
                          q.type === 'success_criteria' ? 'üìä Success Criteria' : '‚ùì Other'}
                    </div>
                    <div class="question-text">${escapeHtml(q.description)}</div>
                    <div class="answer-area">
                        <textarea id="answer-${i}" placeholder="Type your answer here..."></textarea>
                        <div class="voice-controls">
                            <button class="btn-record idle" id="record-btn-${i}" onclick="toggleRecording(${i})">
                                üé§ Record Voice
                            </button>
                            <span id="recording-status-${i}"></span>
                            <button class="btn-submit-answer" onclick="submitAnswer(${i}, '${escapeHtml(q.description)}', '${escapeHtml(q.project)}')">
                                Submit Answer
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Voice Recording
        async function toggleRecording(index) {
            const btn = document.getElementById(`record-btn-${index}`);
            const status = document.getElementById(`recording-status-${index}`);

            if (btn.classList.contains('idle')) {
                // Start recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 48000,
                            channelCount: 1
                        }
                    });
                    // Use higher quality audio format
                    const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                        ? 'audio/webm;codecs=opus'
                        : 'audio/webm';
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: mimeType,
                        audioBitsPerSecond: 128000
                    });
                    audioChunks = [];

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, {type: 'audio/webm'});
                        status.textContent = 'Transcribing...';

                        // Send to backend for transcription
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.webm');

                        try {
                            const resp = await fetch('/api/transcribe', {
                                method: 'POST',
                                body: formData
                            });
                            const data = await resp.json();
                            if (data.text) {
                                document.getElementById(`answer-${index}`).value = data.text;
                                status.textContent = 'Transcribed!';
                            } else {
                                status.textContent = 'Error: ' + (data.error || 'Unknown');
                            }
                        } catch (err) {
                            status.textContent = 'Transcription failed';
                        }

                        stream.getTracks().forEach(t => t.stop());
                    };

                    mediaRecorder.start();
                    btn.classList.remove('idle');
                    btn.classList.add('recording');
                    btn.innerHTML = '‚èπÔ∏è Stop Recording';
                    status.textContent = 'Recording...';
                } catch (err) {
                    alert('Microphone access denied');
                }
            } else {
                // Stop recording
                mediaRecorder.stop();
                btn.classList.remove('recording');
                btn.classList.add('idle');
                btn.innerHTML = 'üé§ Record Voice';
            }
        }

        async function submitAnswer(index, question, project) {
            const answer = document.getElementById(`answer-${index}`).value.trim();
            if (!answer) {
                alert('Please provide an answer');
                return;
            }

            try {
                const resp = await fetch('/api/knowledge/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question, answer, project})
                });
                const data = await resp.json();

                if (data.success) {
                    document.getElementById(`question-${index}`).style.background = '#d4edda';
                    document.getElementById(`question-${index}`).innerHTML += '<div style="color: #155724; margin-top: 10px;">‚úì Answer added to knowledge base!</div>';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Failed to submit answer');
            }
        }

        // Search
        async function doSearch() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) return;

            document.getElementById('search-results').innerHTML = '<div class="loading">Searching...</div>';

            try {
                const resp = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query})
                });
                const data = await resp.json();

                document.getElementById('search-results').innerHTML = `
                    <div class="answer-box">${data.answer || 'No answer found'}</div>
                    <div style="margin-top: 15px; color: #666;">Sources: ${data.num_sources || 0} documents</div>
                `;
            } catch (err) {
                document.getElementById('search-results').innerHTML = '<div class="loading">Search failed</div>';
            }
        }

        async function loadProjectFilters() {
            try {
                const resp = await fetch('/api/projects/names');
                const data = await resp.json();
                // Projects are loaded in questions filter
            } catch (err) {}
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Connectors Functions
        async function loadConnectors() {
            try {
                const resp = await fetch('/api/connectors');
                const data = await resp.json();

                const container = document.getElementById('connectors-list');
                if (!data.connectors || data.connectors.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; color: #666;">No connectors available</div>';
                    return;
                }

                container.innerHTML = data.connectors.map(conn => {
                    const statusColor = conn.status === 'connected' ? '#28a745' :
                                       conn.status === 'coming_soon' ? '#6c757d' : '#ffc107';
                    const statusText = conn.status === 'connected' ? 'Connected' :
                                      conn.status === 'coming_soon' ? 'Coming Soon' : 'Not Connected';
                    const iconMap = {
                        'gmail': 'üìß', 'slack': 'üí¨', 'github': 'üêô',
                        'google_drive': 'üìÅ', 'notion': 'üìù', 'confluence': 'üìö'
                    };
                    return `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 1.5em;">${iconMap[conn.type] || 'üîå'}</span>
                                <strong style="font-size: 1.1em;">${conn.name}</strong>
                                <span style="margin-left: auto; background: ${statusColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.8em;">${statusText}</span>
                            </div>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">${conn.description || ''}</p>
                            ${conn.status !== 'coming_soon' ? `
                                <button onclick="syncConnector('${conn.type}')" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em;" ${conn.status !== 'connected' ? 'disabled' : ''}>
                                    Sync Now
                                </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (err) {
                document.getElementById('connectors-list').innerHTML = '<div class="loading">Error loading connectors</div>';
            }
        }

        async function addConnector() {
            const type = document.getElementById('connector-type').value;
            const token = document.getElementById('connector-token').value;

            if (!token) {
                alert('Please enter an API token');
                return;
            }

            try {
                const resp = await fetch('/api/connectors/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: type,
                        credentials: { access_token: token }
                    })
                });
                const data = await resp.json();

                if (data.success) {
                    alert('Connector added successfully!');
                    document.getElementById('connector-token').value = '';
                    loadConnectors();
                } else {
                    alert('Error: ' + (data.error || 'Failed to add connector'));
                }
            } catch (err) {
                alert('Error adding connector');
            }
        }

        async function syncConnector(type) {
            try {
                const resp = await fetch('/api/connectors/sync', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: type })
                });
                const data = await resp.json();

                if (data.success) {
                    alert(`Synced ${data.count || 0} documents from ${type}`);
                } else {
                    alert('Sync error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error syncing connector');
            }
        }

        // Stakeholders Functions
        async function loadStakeholders() {
            try {
                const resp = await fetch('/api/stakeholders');
                const data = await resp.json();

                const container = document.getElementById('stakeholders-list');
                if (!data.people || data.people.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; color: #666;">No stakeholders found. Upload documents with names and project information.</div>';
                    return;
                }

                container.innerHTML = data.people.slice(0, 50).map(person => `
                    <div style="padding: 15px; border-bottom: 1px solid #eee;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${person.name.charAt(0)}
                            </div>
                            <div style="flex: 1;">
                                <strong>${escapeHtml(person.name)}</strong>
                                ${person.email ? `<span style="color: #666; font-size: 0.85em;"> (${person.email})</span>` : ''}
                                <div style="font-size: 0.85em; color: #666; margin-top: 3px;">
                                    ${person.roles.length ? `Roles: ${person.roles.join(', ')}` : ''}
                                </div>
                                ${person.expertise.length ? `<div style="margin-top: 5px;">${person.expertise.map(e => `<span style="background: #e8f5e9; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">${e}</span>`).join('')}</div>` : ''}
                            </div>
                            <div style="text-align: right; font-size: 0.8em; color: #666;">
                                ${person.documents} docs<br>
                                ${person.mentions} mentions
                            </div>
                        </div>
                    </div>
                `).join('');

                // Load expertise domains
                loadExpertiseDomains();
            } catch (err) {
                document.getElementById('stakeholders-list').innerHTML = '<div class="loading">Error loading stakeholders</div>';
            }
        }

        async function loadExpertiseDomains() {
            try {
                const resp = await fetch('/api/stakeholders/expertise');
                const data = await resp.json();

                const container = document.getElementById('expertise-list');
                if (!data.domains || data.domains.length === 0) {
                    container.innerHTML = '<div style="color: #666;">No expertise domains found</div>';
                    return;
                }

                container.innerHTML = data.domains.map(d => `
                    <div style="padding: 10px; border-left: 3px solid #667eea; margin-bottom: 10px; background: #f8f9fa; border-radius: 0 5px 5px 0;">
                        <strong>${escapeHtml(d.domain)}</strong>
                        <div style="color: #666; font-size: 0.85em;">${d.people_count} people</div>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('expertise-list').innerHTML = '<div class="loading">Error</div>';
            }
        }

        async function searchStakeholders() {
            const query = document.getElementById('stakeholder-search').value.trim();
            if (!query) return;

            const answerDiv = document.getElementById('stakeholder-answer');
            answerDiv.style.display = 'block';
            answerDiv.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const resp = await fetch('/api/stakeholders/query', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ question: query })
                });
                const data = await resp.json();

                if (data.answer) {
                    answerDiv.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 10px;">Answer:</div>
                        <div style="white-space: pre-wrap;">${escapeHtml(data.answer)}</div>
                        ${data.total_results > 0 ? `<div style="margin-top: 10px; color: #666; font-size: 0.9em;">Found ${data.total_results} result(s)</div>` : ''}
                    `;
                } else {
                    answerDiv.innerHTML = '<div style="color: #666;">No results found. Try a different question.</div>';
                }
            } catch (err) {
                answerDiv.innerHTML = '<div style="color: #dc3545;">Error searching stakeholders</div>';
            }
        }

        // Update showStep to load data when switching panels
        const originalShowStep = showStep;
        showStep = function(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            document.getElementById(`panel-${step}`).classList.add('active');

            if (step === 0) loadConnectors();
            if (step === 2) loadQuestions();
            if (step === 4) loadStakeholders();
        }
    </script>
</body>
</html>
