# Render.com Deployment Configuration
# Complete setup for 2ndBrain production deployment

services:
  # Main Web Service (Flask API)
  - type: web
    name: 2ndbrain-api
    runtime: python
    plan: starter  # $7/month - 512MB RAM, can auto-scale
    region: oregon  # Choose: oregon, frankfurt, singapore, ohio
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    startCommand: gunicorn backend.api.app:app --bind 0.0.0.0:$PORT --workers 2 --threads 4 --timeout 120 --access-logfile - --error-logfile -
    envVars:
      # Python config
      - key: PYTHON_VERSION
        value: "3.11"
      - key: PYTHONUNBUFFERED
        value: "1"

      # Flask config
      - key: FLASK_ENV
        value: production
      - key: FLASK_DEBUG
        value: "0"

      # Database (auto-populated by Render when you link PostgreSQL)
      - key: DATABASE_URL
        fromDatabase:
          name: 2ndbrain-db
          property: connectionString

      # Redis (auto-populated when you add Redis)
      - key: REDIS_URL
        fromService:
          type: redis
          name: 2ndbrain-redis
          property: connectionString

      # Secrets (you'll add these manually in Render dashboard)
      - key: OPENAI_API_KEY
        sync: false
      - key: JWT_SECRET_KEY
        generateValue: true  # Render will auto-generate
      - key: MASTER_ENCRYPTION_KEY
        generateValue: true

      # OAuth credentials (add manually)
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: GITHUB_ACCESS_TOKEN
        sync: false
      - key: SLACK_BOT_TOKEN
        sync: false

      # CORS (use your Render URL)
      - key: CORS_ORIGINS
        value: https://2ndbrain-api.onrender.com,https://yourdomain.com

      # Disable Neo4j for now (optional)
      - key: NEO4J_ENABLED
        value: "false"

    # Persistent disk for ChromaDB embeddings
    disk:
      name: chromadb-data
      mountPath: /app/data
      sizeGB: 2  # 2GB free, expandable

    # Auto-deploy from GitHub
    autoDeploy: true

    # Health check endpoint
    healthCheckPath: /api/health

  # PostgreSQL Database
  - type: pserv
    name: 2ndbrain-db
    runtime: postgresql
    plan: starter  # $7/month - 256MB RAM, 1GB storage
    region: oregon  # Must match web service region
    databaseName: secondbrain
    databaseUser: secondbrain_user
    ipAllowList: []  # Empty = allow from Render services only

  # Redis (for caching and Celery job queue)
  - type: redis
    name: 2ndbrain-redis
    plan: starter  # Free tier available, or $10/month
    region: oregon
    maxmemoryPolicy: allkeys-lru  # Evict old keys when memory full
    ipAllowList: []

# Optional: Background Worker (for Celery tasks)
# Uncomment when you implement Celery
#  - type: worker
#    name: 2ndbrain-worker
#    runtime: python
#    plan: starter
#    buildCommand: pip install -r requirements.txt
#    startCommand: celery -A backend.tasks.celery_app worker --loglevel=info
#    envVars:
#      # Same env vars as web service
#      - key: DATABASE_URL
#        fromDatabase:
#          name: 2ndbrain-db
#          property: connectionString
#      - key: REDIS_URL
#        fromService:
#          type: redis
#          name: 2ndbrain-redis
#          property: connectionString
